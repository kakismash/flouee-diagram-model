name: Deploy to Netlify

on:
  push:
    branches:
      - master
  workflow_dispatch: # Allow manual trigger

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: production  # Use GitHub environment for secrets
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: TypeScript type check
        working-directory: ./frontend
        run: npx tsc --noEmit
        continue-on-error: false

      - name: Build application
        working-directory: ./frontend
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: npm run build

      - name: Verify build output
        working-directory: ./frontend
        run: |
          if [ ! -d "dist/frontend/browser" ]; then
            echo "‚ùå Build output directory not found!"
            exit 1
          fi
          if [ ! -f "dist/frontend/browser/index.html" ]; then
            echo "‚ùå index.html not found in build output!"
            exit 1
          fi
          echo "‚úÖ Build output verified"

      - name: Setup Netlify CLI
        run: |
          npm install -g netlify-cli
          # Install jq for JSON parsing
          sudo apt-get update && sudo apt-get install -y jq

      - name: Check or Create Netlify Site
        id: netlify-site
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        run: |
          # Verify NETLIFY_AUTH_TOKEN is set
          if [ -z "$NETLIFY_AUTH_TOKEN" ]; then
            echo "‚ùå ERROR: NETLIFY_AUTH_TOKEN is not set!"
            echo ""
            echo "Please add NETLIFY_AUTH_TOKEN to GitHub Secrets:"
            echo "1. Go to: https://github.com/${{ github.repository }}/settings/secrets/actions"
            echo "2. Click 'New repository secret'"
            echo "3. Name: NETLIFY_AUTH_TOKEN"
            echo "4. Value: (get it from https://app.netlify.com/user/applications)"
            echo ""
            exit 1
          fi
          
          # Authenticate Netlify CLI
          # Netlify CLI reads NETLIFY_AUTH_TOKEN from environment automatically
          export NETLIFY_AUTH_TOKEN="$NETLIFY_AUTH_TOKEN"
          echo "‚úÖ Netlify authentication token is set"
          
          # Verify token is not empty (basic check)
          if [ ${#NETLIFY_AUTH_TOKEN} -lt 10 ]; then
            echo "‚ùå ERROR: NETLIFY_AUTH_TOKEN appears to be invalid (too short)"
            exit 1
          fi
          
          # Check if NETLIFY_SITE_ID is empty or only whitespace
          # Trim whitespace and check if empty
          NETLIFY_SITE_ID_TRIMMED=$(echo "$NETLIFY_SITE_ID" | xargs)
          
          if [ -z "$NETLIFY_SITE_ID_TRIMMED" ]; then
            echo "‚ö†Ô∏è  NETLIFY_SITE_ID not set. Creating a new Netlify site..."
            echo "üìù Site name: flouee-diagram-model"
            
            # Create a new site
            # First, verify Netlify CLI is working
            echo "üîç Verifying Netlify CLI installation..."
            NETLIFY_VERSION=$(netlify --version 2>&1 || echo "unknown")
            echo "   Netlify CLI version: $NETLIFY_VERSION"
            echo ""
            
            # Verify token format (should start with specific pattern)
            TOKEN_PREFIX=$(echo "$NETLIFY_AUTH_TOKEN" | cut -c1-10)
            echo "üîç Token verification (first 10 chars): ${TOKEN_PREFIX}..."
            echo ""
            
            # Try to create site - Netlify CLI should read NETLIFY_AUTH_TOKEN from env
            echo "üöÄ Executing: netlify sites:create --name flouee-diagram-model"
            echo "üìù Using NETLIFY_AUTH_TOKEN from environment..."
            echo ""
            
            # Capture both stdout and stderr, don't fail immediately
            set +e  # Don't exit on error immediately
            SITE_OUTPUT=$(netlify sites:create --name "flouee-diagram-model" 2>&1)
            EXIT_CODE=$?
            set -e  # Re-enable exit on error
            
            echo ""
            echo "üìã Netlify CLI exit code: $EXIT_CODE"
            echo "üìã Netlify CLI full output:"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "$SITE_OUTPUT"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo ""
            
            if [ $EXIT_CODE -eq 0 ]; then
              # Extract site ID from output
              # Netlify CLI output format: "Site created: https://xxxxx.netlify.app (xxxxx-xxxx-xxxx-xxxx-xxxxx)"
              # Or: "Site created. Site ID: xxxxx-xxxx-xxxx-xxxx-xxxxx"
              
              # Try to extract from URL pattern
              SITE_ID=$(echo "$SITE_OUTPUT" | grep -oE 'https://[a-zA-Z0-9-]+\.netlify\.app' | sed 's|https://||' | sed 's|\.netlify\.app||' | head -1 || echo "")
              
              # Try to extract from "Site ID:" pattern
              if [ -z "$SITE_ID" ]; then
                SITE_ID=$(echo "$SITE_OUTPUT" | grep -i "site id" | grep -oE '[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}' | head -1 || echo "")
              fi
              
              # Try to extract from parentheses pattern: (xxxxx-xxxx-xxxx-xxxx-xxxxx)
              if [ -z "$SITE_ID" ]; then
                SITE_ID=$(echo "$SITE_OUTPUT" | grep -oE '\([a-f0-9-]+\)' | sed 's/[()]//g' | head -1 || echo "")
              fi
              
              # Last resort: extract any UUID-like string
              if [ -z "$SITE_ID" ]; then
                SITE_ID=$(echo "$SITE_OUTPUT" | grep -oE '[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}' | head -1 || echo "")
              fi
              
              # Try to extract site name from URL (sometimes the site name is the ID)
              if [ -z "$SITE_ID" ]; then
                SITE_ID=$(echo "$SITE_OUTPUT" | grep -oE 'netlify\.app/[^[:space:]]+' | sed 's|netlify\.app/||' | head -1 || echo "")
              fi
              
              if [ -z "$SITE_ID" ]; then
                echo "‚ùå Failed to extract site ID from Netlify response"
                echo ""
                echo "Netlify output was:"
                echo "$SITE_OUTPUT"
                echo ""
                echo "Please manually extract the Site ID from the output above and update the NETLIFY_SITE_ID secret."
                echo ""
                echo "The Site ID is usually:"
                echo "  - The subdomain in the URL (e.g., 'xxxxx' from 'https://xxxxx.netlify.app')"
                echo "  - Or a UUID shown in the output"
                exit 1
              fi
              
              echo "‚úÖ New Netlify site created successfully!"
              echo "üìã Site ID extracted: $SITE_ID"
              echo "üìã SITE_ID=$SITE_ID" >> $GITHUB_OUTPUT
              echo ""
              echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
              echo "üîë IMPORTANT: Update NETLIFY_SITE_ID in GitHub Secrets"
              echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
              echo ""
              echo "The NETLIFY_SITE_ID secret exists but is empty. Update it with:"
              echo ""
              echo "Secret Name: NETLIFY_SITE_ID"
              echo "Secret Value: $SITE_ID"
              echo ""
              echo "Steps to update:"
              echo "1. Go to: https://github.com/${{ github.repository }}/settings/secrets/actions"
              echo "2. Find 'NETLIFY_SITE_ID' in the list"
              echo "3. Click the pencil icon (‚úèÔ∏è) to edit"
              echo "4. Paste this value: $SITE_ID"
              echo "5. Click 'Update secret'"
              echo ""
              echo "Or if using GitHub Environment 'production':"
              echo "1. Go to: https://github.com/${{ github.repository }}/settings/environments"
              echo "2. Click on 'production' environment"
              echo "3. Find 'NETLIFY_SITE_ID' in the secrets list"
              echo "4. Click 'Update' and paste: $SITE_ID"
              echo ""
              echo "After updating, future deployments will use this site automatically."
              echo ""
              echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
              echo ""
            else
              echo "‚ùå Failed to create Netlify site"
              echo ""
              echo "Exit code: $EXIT_CODE"
              echo ""
              echo "Netlify CLI output:"
              echo "$SITE_OUTPUT"
              echo ""
              echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
              echo "üîç Troubleshooting Steps:"
              echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
              echo ""
              echo "1. Verify NETLIFY_AUTH_TOKEN is valid:"
              echo "   - Go to: https://app.netlify.com/user/applications"
              echo "   - Check if the token exists and is active"
              echo "   - If not, create a new token and update GitHub Secrets"
              echo ""
              echo "2. Check token permissions:"
              echo "   - The token must have permission to create sites"
              echo "   - Verify your Netlify account has site creation enabled"
              echo ""
              echo "3. Try creating site manually:"
              echo "   - Go to: https://app.netlify.com/"
              echo "   - Click 'Add new site' ‚Üí 'Import an existing project'"
              echo "   - Choose 'Deploy manually'"
              echo "   - Copy the Site ID and add it as NETLIFY_SITE_ID secret"
              echo ""
              echo "4. Check Netlify account limits:"
              echo "   - Free accounts have limits on number of sites"
              echo "   - Verify you haven't reached the limit"
              echo ""
              echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
              exit 1
            fi
          else
            echo "‚úÖ Using existing Netlify site: $NETLIFY_SITE_ID"
            echo "üìã SITE_ID=$NETLIFY_SITE_ID_TRIMMED" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to Netlify
        uses: netlify/actions/cli@master
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ steps.netlify-site.outputs.SITE_ID || secrets.NETLIFY_SITE_ID }}
        with:
          args: deploy --dir=frontend/dist/frontend/browser --prod

      - name: Netlify deployment summary
        if: success()
        env:
          NETLIFY_SITE_ID: ${{ steps.netlify-site.outputs.SITE_ID || secrets.NETLIFY_SITE_ID }}
        run: |
          echo "‚úÖ Deployment to Netlify completed successfully!"
          if [ -n "$NETLIFY_SITE_ID" ]; then
            echo "üåê Your site should be live at: https://$NETLIFY_SITE_ID.netlify.app"
          fi

